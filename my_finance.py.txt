import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import datetime

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© ---
st.set_page_config(page_title="Ù†Ø¸Ø§Ù…ÙŠ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„", layout="wide")

# --- 1. Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© Ù…Ù† ØµÙˆØ±Ùƒ) ---
if 'db' not in st.session_state:
    st.session_state.db = {
        'salary': 12835.0,
        'housing_support': 1040.0,
        'investments': {
            'Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ Ø§Ù„Ù…Ø±Ù† (Ù…Ø­Ù„ÙŠ)': 92057.38,
            'Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ Ø§Ù„Ù‚ÙŠØ§Ø¯ÙŠ (Ù…Ø­Ù„ÙŠ)': 65964.96,
            'Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ Ø§Ù„Ù†Ø´Ø· (Ù…Ø­Ù„ÙŠ)': 63249.39,
            'Ù…Ø´ÙˆØ±Ø© Ù†Ù…Ùˆ (Ø¹Ø§Ù„Ù…ÙŠ)': 19823.00,
            'Ù…Ø´ÙˆØ±Ø© ØªÙˆØ²ÙŠØ¹Ø§Øª (Ø¹Ø§Ù„Ù…ÙŠ)': 2656.00,
            'Ø¯Ø±Ø§ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ù…Ø­Ù„ÙŠ)': 3576.28
        },
        'debts': {
            'Ø§Ù„Ù‚Ø±Ø¶ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': 624227.45,
            'Ø§Ù„Ù‚Ø±Ø¶ Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': 104882.85
        },
        'expenses': {
            'Ù‚Ø³Ø· Ø§Ù„Ù‚Ø±Ø¶ Ø§Ù„Ø´Ø®ØµÙŠ': 3617.0,
            'Ù‚Ø³Ø· Ø§Ù„Ø¹Ù‚Ø§Ø± (ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø¹Ù…)': 2189.0,
            'Ø±Ø§ØªØ¨ Ø§Ù„Ø³Ø§Ø¦Ù‚': 700.0,
            'Ø¹Ø§Ù…Ù„Ø© Ù…Ù†Ø²Ù„ÙŠØ© (Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ)': 1200.0
        }
    }

# --- 2. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ---
def get_total_assets():
    return sum(st.session_state.db['investments'].values())

def get_total_debts():
    return sum(st.session_state.db['debts'].values())

# --- 3. ØªØµÙ…ÙŠÙ… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ ---
st.title("ğŸ¦ Ù…Ø­ÙØ¸ØªÙŠ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©")
st.markdown(f"**ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø¯ÙŠØ«:** {datetime.now().strftime('%Y-%m-%d')}")

tabs = st.tabs(["ğŸ’ Ù…Ù„Ø®Øµ Ø§Ù„Ø«Ø±ÙˆØ©", "ğŸ“‰ Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª", "ğŸ•Œ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²ÙƒØ§Ø©", "ğŸ”® ØªÙˆÙ‚Ø¹Ø§Øª 5 Ø³Ù†ÙˆØ§Øª", "âš™ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"])

# --- Ø§Ù„ØªØ¨ÙˆÙŠØ¨ 1: Ù…Ù„Ø®Øµ Ø§Ù„Ø«Ø±ÙˆØ© ---
with tabs[0]:
    assets = get_total_assets()
    liabilities = get_total_debts()
    
    col1, col2, col3 = st.columns(3)
    col1.metric("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª", f"{assets:,.2f} Ø±ÙŠØ§Ù„")
    col2.metric("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª", f"{liabilities:,.2f} Ø±ÙŠØ§Ù„", delta_color="inverse")
    col3.metric("ØµØ§ÙÙŠ Ø§Ù„Ø«Ø±ÙˆØ©", f"{assets - liabilities:,.2f} Ø±ÙŠØ§Ù„")

    df_inv = pd.DataFrame(list(st.session_state.db['investments'].items()), columns=['Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚', 'Ø§Ù„Ù‚ÙŠÙ…Ø©'])
    fig = px.pie(df_inv, values='Ø§Ù„Ù‚ÙŠÙ…Ø©', names='Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚', title="ØªÙˆØ²ÙŠØ¹ Ø£ÙˆØ²Ø§Ù† Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±")
    st.plotly_chart(fig)

# --- Ø§Ù„ØªØ¨ÙˆÙŠØ¨ 2: Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ---
with tabs[1]:
    st.subheader("âš ï¸ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª")
    col_d1, col_d2 = st.columns(2)
    with col_d1:
        st.write("**Ø§Ù„Ù‚Ø±ÙˆØ¶ Ø§Ù„Ø¨Ù†ÙƒÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:**")
        st.table(pd.DataFrame(list(st.session_state.db['debts'].items()), columns=['Ø§Ù„Ø¨Ù†Ø¯', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ']))
    with col_d2:
        st.write("**Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©:**")
        st.table(pd.DataFrame(list(st.session_state.db['expenses'].items()), columns=['Ø§Ù„Ø¨Ù†Ø¯', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ']))

# --- Ø§Ù„ØªØ¨ÙˆÙŠØ¨ 3: Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²ÙƒØ§Ø© ---
with tabs[2]:
    st.subheader("âš–ï¸ ÙˆØ¹Ø§Ø¡ Ø§Ù„Ø²ÙƒØ§Ø© Ø§Ù„Ø³Ù†ÙˆÙŠ")
    zakat_list = []
    for name, val in st.session_state.db['investments'].items():
        if 'Ù…Ø­Ù„ÙŠ' in name:
            z_val = val * 0.025
        else: # Ø¹Ø§Ù„Ù…ÙŠ
            z_val = (val * 0.25) * 0.025
        zakat_list.append({"Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚": name, "Ø§Ù„Ø²ÙƒØ§Ø© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©": round(z_val, 2)})
    
    st.table(pd.DataFrame(zakat_list))
    st.info("ğŸ’¡ ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø²ÙƒØ§Ø© Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ø¹Ù„Ù‰ 25% Ù…Ù† Ù‚ÙŠÙ…ØªÙ‡Ø§ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØªØ§ÙˆÙ‰ Ø§Ù„Ù…Ø¹Ø§ØµØ±Ø©.")

# --- Ø§Ù„ØªØ¨ÙˆÙŠØ¨ 4: Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨ÙŠÙ„Ø© ---
with tabs[3]:
    st.subheader("ğŸ”® Ù†Ù…Ùˆ Ø§Ù„Ø«Ø±ÙˆØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (AI Forecast)")
    years = st.select_slider("Ø§Ø®ØªØ± Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©", options=[1, 2, 3, 4, 5], value=5)
    
    # Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø³ÙŠØ·Ø©
    projection = []
    current_a = assets
    current_d = liabilities
    for y in range(1, years + 1):
        current_a *= 1.08 # Ø§ÙØªØ±Ø§Ø¶ Ù†Ù…Ùˆ 8%
        current_a += (2500 * 12) # Ø§ÙØªØ±Ø§Ø¶ Ø§Ø³ØªØ«Ù…Ø§Ø± 2500 Ø´Ù‡Ø±ÙŠØ§Ù‹
        current_d -= (7000 * 12) # Ø§ÙØªØ±Ø§Ø¶ Ø³Ø¯Ø§Ø¯ Ø¯ÙŠÙˆÙ†
        if current_d < 0: current_d = 0
        projection.append({"Ø§Ù„Ø³Ù†Ø©": f"Ø³Ù†Ø© {y}", "Ø§Ù„Ø£ØµÙˆÙ„": current_a, "Ø§Ù„Ø¯ÙŠÙˆÙ†": current_d})
    
    st.line_chart(pd.DataFrame(projection).set_index("Ø§Ù„Ø³Ù†Ø©"))

# --- Ø§Ù„ØªØ¨ÙˆÙŠØ¨ 5: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
with tabs[4]:
    st.subheader("ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… ÙŠØ¯ÙˆÙŠØ§Ù‹")
    with st.form("update_form"):
        st.write("Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø³ÙˆÙ‚ÙŠØ© Ù„Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ù‡Ù†Ø§:")
        updated_vals = {}
        for name, val in st.session_state.db['investments'].items():
            updated_vals[name] = st.number_input(f"Ù‚ÙŠÙ…Ø© {name}", value=val)
        
        if st.form_submit_button("Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«"):
            st.session_state.db['investments'] = updated_vals
            st.success("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­!")
